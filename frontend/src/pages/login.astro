---
import Layout from "../layouts/Layout.astro";
const next = Astro.url.searchParams.get("next") || "/"; // redir après login
---
<Layout title="Connexion">
  <h1>Connexion</h1>
  <form id="loginForm" class="stack" novalidate>
    <label>
      Identifiant (email ou matricule UMONS)
      <input id="ident" name="ident" type="text" placeholder="email OU ID 6 chiffres" autocomplete="username" required />
    </label>
    <label>
      Mot de passe
      <input id="password" name="password" type="password" placeholder="••••••••" autocomplete="current-password" required />
    </label>
    <button type="submit">Se connecter</button>
    <p id="err" style="color:#b00;"></p>
  </form>

  <style>
    .stack { display:flex; flex-direction:column; gap:.8rem; max-width:380px }
    input, button { padding:.55rem .7rem; font-size:1rem }
  </style>
</Layout>

<script>
  const form = document.getElementById('loginForm');
  const $err = document.getElementById('err');

  function isSixDigits(s){ return /^\d{6}$/.test(s.trim()); }
  function isEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.trim()); }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    $err.textContent = '';

    const ident = document.getElementById('ident').value.trim();
    const password = document.getElementById('password').value;

    if (!ident || !password) { $err.textContent = "Identifiant et mot de passe requis."; return; }

    let payload = { password };
    if (isEmail(ident)) {
      payload.email = ident.toLowerCase();
    } else if (isSixDigits(ident)) {
      payload.identifiant = ident; // côté backend: pris en charge
    } else {
      $err.textContent = "Saisis un email valide ou un ID à 6 chiffres.";
      return;
    }

    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      credentials: 'include',
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      try {
        const j = await res.json();
        $err.textContent = j.error || ('Erreur ' + res.status);
      } catch {
        $err.textContent = 'Erreur ' + res.status;
      }
      return;
    }

    // OK → redirige
    const next = new URLSearchParams(window.location.search).get('next') || '/';
    location.href = next;
  });
</script>
