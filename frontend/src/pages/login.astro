---
const redirectTo = Astro.url.searchParams.get('next') ?? '/admin';
---
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Connexion</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      form { max-width: 360px; display: grid; gap: 0.75rem; }
      input, button { padding: 0.6rem 0.8rem; font-size: 1rem; }
      .error { color: #b00020; }
      .hint { color: #666; font-size: .9rem; }
    </style>
  </head>
  <body>
    <h1>Connexion</h1>
    <p class="hint">Identifiant = email. (admin@example.com / monpass)</p>
    <form id="login">
      <label>Email<br/><input name="email" type="email" required autocomplete="username" /></label>
      <label>Mot de passe<br/><input name="password" type="password" required autocomplete="current-password" /></label>
      <button type="submit">Se connecter</button>
      <div id="msg" class="error" aria-live="polite"></div>
    </form>

    <script>
      const form = document.getElementById('login');
      const msg  = document.getElementById('msg');
      const next = new URLSearchParams(location.search).get('next') ?? '/admin';

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.textContent = '';
        const data = Object.fromEntries(new FormData(form).entries());

        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data),
          credentials: 'include' // <- indispensable pour recevoir le cookie de session
        });

        if (res.ok) {
          location.href = next;
        } else {
          let text = 'Ã‰chec de la connexion';
          try { const j = await res.json(); if (j?.error) text = j.error; } catch {}
          msg.textContent = text;
        }
      });
    </script>
  </body>
</html>
