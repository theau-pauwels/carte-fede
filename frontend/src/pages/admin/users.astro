---
import Layout from "../../layouts/Layout.astro";
---
<Layout title="Gestion des utilisateurs">
  <main class="flex-1 flex flex-col gap-4 items-center p-4 justify-center">
  <h1 class="font-semibold text-2xl text-blue-800 bg-white mb-1">Gestion des utilisateurs</h1>

  <table id="tbl">
    <thead>
      <tr>
        <th>Nom</th>
        <th>PrÃ©nom</th>
        <th>Identifiant</th>
        <th>Cartes (annÃ©e â†’ nÂ°)</th>
        <th>Ajouter une carte</th>
        <th>RÃ´le</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </main>
</Layout>

<script>
  const ALLOWED_PREFIXES = ["A","F","E","EA","MI","S"];
  const ROLE_OPTIONS = ["member","verifier","admin"]; // ðŸ‘ˆ options affichÃ©es dans la colonne RÃ´le

  // ---------- Utilitaires annÃ©e ----------
  function currentAcademicStartYear() {
    const d = new Date();
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    return (m >= 8) ? y : (y - 1);
  }

  function makeYearRanges(countBefore=2, countAfter=6) {
    const start = currentAcademicStartYear();
    const arr = [];
    for (let k = -countBefore; k <= countAfter; k++) {
      const y = start + k;
      arr.push(`${y}-${y+1}`);
    }
    return arr;
  }

  function yearRangeLabelFromStart(startYear) { return `${startYear}-${startYear+1}`; }

  function startYearFromLabel(label) {
    const s = String(label||"").trim();
    const left = s.includes("-") ? s.split("-")[0] : s;
    const n = parseInt(left, 10);
    return Number.isFinite(n) ? n : null;
  }

  // ---------- Index des numÃ©ros pris ----------
  function buildTakenIndex(users) {
    const taken = {};
    for (const u of users) {
      const cartes = u.cartes || {};
      for (const [yearStr, code] of Object.entries(cartes)) {
        const year = parseInt(yearStr, 10);
        if (!Number.isFinite(year)) continue;
        const [rawPrefix, rawNum] = (code||"").toUpperCase().split("-");
        if (!rawPrefix || !rawNum || !/^\d+$/.test(rawNum)) continue;
        const prefix = rawPrefix.trim();
        const num = parseInt(rawNum, 10);
        if (!ALLOWED_PREFIXES.includes(prefix) || num < 1) continue;

        if (!taken[year]) taken[year] = {};
        if (!taken[year][prefix]) taken[year][prefix] = new Set();
        taken[year][prefix].add(num);
      }
    }
    return taken;
  }

  function nextFreeNumber(taken, yearStart, prefix) {
    if (!yearStart || !prefix) return 1;
    const used = taken?.[yearStart]?.[prefix];
    if (!used) return 1;
    let n = 1;
    while (used.has(n)) n++;
    return n;
  }

  // ---------- API ----------
  async function ensureAdmin() {
    const me = await fetch('/api/me', { credentials: 'include' });
    if (!me.ok) { location.href = '/login?next=' + encodeURIComponent(location.pathname); return false; }
    const j = await me.json();
    if (j.role !== 'admin') { location.href = '/'; return false; }
    return true;
  }

  async function fetchUsers() {
    const res = await fetch('/api/admin/users', { credentials: 'include' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  // ---------- Rendu ----------
  function render(users) {
    const tb = document.querySelector('#tbl tbody');

    const fmtCartes = (cartes, userId) => {
      const entries = Object.entries(cartes || {});
      if (!entries.length) return '<span class="muted">â€”</span>';
      entries.sort((a,b)=>Number(b[0])-Number(a[0]));
      return entries.map(([y,c]) => `
        ${yearRangeLabelFromStart(Number(y))} â†’ ${c}
        <button class="btn-del" data-user="${userId}" data-year="${y}" data-code="${c}" style="margin-left:6px">ðŸ—‘</button>
      `).join('<br/>');
    };

    const yearRanges = makeYearRanges();
    const optionsHtml = yearRanges.map(r => `<option value="${r}">${r}</option>`).join('');
    const taken = buildTakenIndex(users);

    tb.innerHTML = users.map(u => `
      <tr>
        <td>${u.nom}</td>
        <td>${u.prenom}</td>
        <td>${u.identifiant ?? ''}</td>
        <td>${fmtCartes(u.cartes, u.id)}</td>
        <td>
          <form class="inline form-carte" data-user="${u.id}">
            <select name="annee" required>${optionsHtml}</select>
            <select name="prefix" required>
              ${ALLOWED_PREFIXES.map(p => `<option value="${p}">${p}</option>`).join('')}
            </select>
            <input type="text" name="num" placeholder="NumÃ©ro" required pattern="\\d+" inputmode="numeric" />
            <button type="submit">âž•</button>
            <small class="muted" style="display:block">Format: PREFIX-Num (ex: A-23)</small>
          </form>
        </td>
        <td>
          <div class="role-box" data-user="${u.id}">
            <select name="role">
              ${ROLE_OPTIONS.map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}
            </select>
            <button class="btn-role-apply">Appliquer</button>
          </div>
        </td>
      </tr>
    `).join('');

    // -------- Ajout / maj de carte --------
    document.querySelectorAll('.form-carte').forEach(f => {
      const selYear = f.querySelector('select[name="annee"]');
      const selPrefix = f.querySelector('select[name="prefix"]');
      const inputNum = f.querySelector('input[name="num"]');

      function refreshDefaultNumber(force = false) {
        const yearStart = startYearFromLabel(selYear.value);
        const prefix = String(selPrefix.value||'').toUpperCase();
        const suggestion = nextFreeNumber(taken, yearStart, prefix);
        if (force || !/^\d+$/.test(inputNum.value)) {
          inputNum.value = String(suggestion);
        }
        inputNum.placeholder = String(suggestion);
      }

      selYear.addEventListener('change', () => refreshDefaultNumber(true));   // force recalcul
      selPrefix.addEventListener('change', () => refreshDefaultNumber(true)); // idem
      refreshDefaultNumber(true);

      f.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = f.dataset.user;
        const yearStart = startYearFromLabel(selYear.value);
        const prefix = String(selPrefix.value||'').toUpperCase();

        let num = parseInt(inputNum.value, 10);
        if (!Number.isFinite(num) || num < 1) num = nextFreeNumber(taken, yearStart, prefix);

        const anneeLabel = selYear.value;
        const annee_code = `${prefix}-${num}`;

        const r = await fetch(`/api/admin/users/${userId}/annees`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ annee: anneeLabel, annee_code })
        });

        if (!r.ok) {
          let msg = 'Erreur ' + r.status;
          try { const j=await r.json(); if (j.error) msg=j.error; } catch {}
          alert(msg);
          return;
        }
        render(await fetchUsers());
      });
    });

    // -------- Suppression de carte --------
    document.querySelectorAll('.btn-del').forEach(btn => {
      btn.addEventListener('click', async () => {
        const userId = btn.dataset.user;
        const year = btn.dataset.year;
        const code = btn.dataset.code;
        if (!confirm(`Supprimer la carte ${code} pour ${yearRangeLabelFromStart(Number(year))} ?`)) return;

        const r = await fetch(`/api/admin/users/${userId}/annees/${year}`, {
          method:'DELETE',
          credentials:'include'
        });

        if (!r.ok) {
          let msg = 'Erreur ' + r.status;
          try { const j=await r.json(); if (j.error) msg=j.error; } catch {}
          alert(msg);
          return;
        }
        render(await fetchUsers());
      });
    });

    // -------- Changement de rÃ´le --------
    document.querySelectorAll('.role-box').forEach(box => {
      const userId = box.dataset.user;
      const sel = box.querySelector('select[name="role"]');
      const btn = box.querySelector('.btn-role-apply');

      btn.addEventListener('click', async () => {
        const role = sel.value;
        const r = await fetch(`/api/admin/users/${userId}/role`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ role })
        });
        if (!r.ok) {
          let msg = 'Erreur ' + r.status;
          try { const j=await r.json(); if (j.error) msg=j.error; } catch {}
          alert(msg);
          return;
        }
        render(await fetchUsers());
      });
    });
  }

  (async () => {
    if (!await ensureAdmin()) return;
    try { render(await fetchUsers()); }
    catch (e) { alert('Chargement impossible: '+e.message); }
  })();
</script>
