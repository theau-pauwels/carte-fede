---
import Layout from "../layouts/Layout.astro";
---
<Layout title="Mes cartes">
  <main class="flex-1 flex flex-col gap-4 items-center p-4 justify-center">
  <h1 class="font-semibold text-2xl text-blue-800 bg-white mb-1">Mes cartes</h1>

  <table id="tbl">
    <thead>
      <tr><th>Année</th><th>Numéro</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <p style="margin-top:.75rem">
    <a href="/app/qr">→ Afficher mon QR</a>
  </p>

  <style>
    table{border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:.5rem .7rem}
    th{background:#f6f6f7}
    body{font-family:system-ui}
  </style>
  </main>
</Layout>

<script>
  (async () => {
    // Doit être connecté
    const me = await fetch('/api/me', { credentials:'include' });
    if (!me.ok) { location.href = '/login?next=' + encodeURIComponent(location.pathname); return; }

    const res = await fetch('/api/memberships', { credentials:'include' });
    const tb = document.querySelector('#tbl tbody');

    if (!res.ok) { tb.innerHTML = `<tr><td colspan="2">Erreur ${res.status}</td></tr>`; return; }

    const data = await res.json();
    if (!Array.isArray(data) || !data.length) {
      tb.innerHTML = `<tr><td colspan="2">Aucune carte</td></tr>`;
      return;
    }

    data.sort((a,b)=>b.annee - a.annee); // plus récentes d’abord
    const row = x => `<tr><td>${x.annee}-${x.annee+1}</td><td>${x.annee_code ?? ''}</td></tr>`;
    tb.innerHTML = data.map(row).join('');
  })();
</script>
