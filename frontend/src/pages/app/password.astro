---
---
<html lang="fr">
  <head>
    <meta charset="utf-8"/><title>Changer mon mot de passe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>body{font-family:system-ui;margin:2rem} .ok{color:#0a7}.err{color:#b00020}</style>
  </head>
  <body>
    <h1>Changer mon mot de passe</h1>
    <form id="pw" style="display:grid;gap:.75rem;max-width:360px">
      <input name="old_password" type="password" placeholder="Ancien mot de passe" required />
      <input name="new_password" type="password" placeholder="Nouveau mot de passe (min 8)" minlength="8" required />
      <button>Mettre à jour</button>
      <div id="msg" aria-live="polite"></div>
    </form>
    <script>
      (async () => {
        const r = await fetch('/api/me', { credentials:'include' });
        if (!r.ok) return location.href = '/login?next=' + encodeURIComponent(location.pathname);
      })();

      document.getElementById('pw').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msg'); msg.className=''; msg.textContent='';
        const data = Object.fromEntries(new FormData(e.target).entries());
        const r = await fetch('/api/auth/change-password', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data),
          credentials:'include'
        });
        if (r.ok) { msg.className='ok'; msg.textContent = 'Mot de passe mis à jour ✅'; }
        else { try { const j=await r.json(); msg.className='err'; msg.textContent = j.error || 'Erreur'; } catch { msg.textContent='Erreur'; } }
      });
    </script>
  </body>
</html>
